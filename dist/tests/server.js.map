{"version":3,"file":"server.js","sources":["../../src/tests/server.ts"],"sourcesContent":["import { Response, Router } from \"express\"\n\nconst router = Router()\nconst streamResponses: Set<Response> = new Set\n\nrouter.post(\"/messages\", (request, response) => {\n  const { content } = request.body\n  if (typeof content == \"string\") {\n    receiveMessage(content)\n    response.sendStatus(201)\n  } else {\n    response.sendStatus(422)\n  }\n})\n\nrouter.get(\"/messages\", (request, response) => {\n  response.set({\n    \"Cache-Control\": \"no-cache\",\n    \"Content-Type\": \"text/event-stream\",\n    \"Connection\": \"keep-alive\"\n  })\n\n  response.on(\"close\", () => {\n    streamResponses.delete(response)\n    response.end()\n  })\n\n  response.flushHeaders()\n  response.write(\"data:\\n\\n\")\n  streamResponses.add(response)\n})\n\nfunction receiveMessage(content: string) {\n  const data = renderSSEData(renderMessage(content))\n  for (const response of streamResponses) {\n    intern.log(\"delivering message to stream\", response.socket?.remotePort)\n    response.write(data)\n  }\n}\n\nfunction renderMessage(content: string) {\n  return `\n    <turbo-stream action=\"append\" target=\"messages\"><template>\n      <div class=\"message\">${escapeHTML(content)}</div>\n    </template></turbo-stream>\n  `\n}\n\nfunction renderSSEData(data: any) {\n  return `${data}`.split(\"\\n\").map(line => \"data:\" + line).join(\"\\n\") + \"\\n\\n\"\n}\n\nfunction escapeHTML(html: string) {\n  return html.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\")\n}\n\nexport const TestServer = router\n"],"names":["Router"],"mappings":";;;;;;AAEA,MAAM,MAAM,GAAGA,cAAM,EAAE,CAAA;AACvB,MAAM,eAAe,GAAkB,IAAI,GAAG,CAAA;AAE9C,MAAM,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,OAAO,EAAE,QAAQ;IACzC,MAAM,EAAE,OAAO,EAAE,GAAG,OAAO,CAAC,IAAI,CAAA;IAChC,IAAI,OAAO,OAAO,IAAI,QAAQ,EAAE;QAC9B,cAAc,CAAC,OAAO,CAAC,CAAA;QACvB,QAAQ,CAAC,UAAU,CAAC,GAAG,CAAC,CAAA;KACzB;SAAM;QACL,QAAQ,CAAC,UAAU,CAAC,GAAG,CAAC,CAAA;KACzB;AACH,CAAC,CAAC,CAAA;AAEF,MAAM,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC,OAAO,EAAE,QAAQ;IACxC,QAAQ,CAAC,GAAG,CAAC;QACX,eAAe,EAAE,UAAU;QAC3B,cAAc,EAAE,mBAAmB;QACnC,YAAY,EAAE,YAAY;KAC3B,CAAC,CAAA;IAEF,QAAQ,CAAC,EAAE,CAAC,OAAO,EAAE;QACnB,eAAe,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAA;QAChC,QAAQ,CAAC,GAAG,EAAE,CAAA;KACf,CAAC,CAAA;IAEF,QAAQ,CAAC,YAAY,EAAE,CAAA;IACvB,QAAQ,CAAC,KAAK,CAAC,WAAW,CAAC,CAAA;IAC3B,eAAe,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAA;AAC/B,CAAC,CAAC,CAAA;AAEF,SAAS,cAAc,CAAC,OAAe;;IACrC,MAAM,IAAI,GAAG,aAAa,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,CAAA;IAClD,KAAK,MAAM,QAAQ,IAAI,eAAe,EAAE;QACtC,MAAM,CAAC,GAAG,CAAC,8BAA8B,QAAE,QAAQ,CAAC,MAAM,0CAAE,UAAU,CAAC,CAAA;QACvE,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;KACrB;AACH,CAAC;AAED,SAAS,aAAa,CAAC,OAAe;IACpC,OAAO;;6BAEoB,UAAU,CAAC,OAAO,CAAC;;GAE7C,CAAA;AACH,CAAC;AAED,SAAS,aAAa,CAAC,IAAS;IAC9B,OAAO,GAAG,IAAI,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,IAAI,IAAI,OAAO,GAAG,IAAI,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,MAAM,CAAA;AAC9E,CAAC;AAED,SAAS,UAAU,CAAC,IAAY;IAC9B,OAAO,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,MAAM,CAAC,CAAA;AAC1D,CAAC;MAEY,UAAU,GAAG;;;;"}